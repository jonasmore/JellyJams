{% extends "base.html" %}

{% block title %}Settings - JellyJams{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-cog text-primary me-2"></i>Settings
        </h1>
        <div id="alertContainer" class="mt-3"></div>
    </div>
</div>

<form id="settingsForm">
    <!-- Jellyfin Configuration and Playlist Limits -->
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-server me-2"></i>Jellyfin Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="jellyfin_url" class="form-label">Jellyfin URL</label>
                        <input type="url" class="form-control" id="jellyfin_url" name="jellyfin_url" value="{{ settings.jellyfin_url }}" required>
                        <div class="form-text">URL of your Jellyfin server (e.g., http://jellyfin:8096)</div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-sliders-h me-2"></i>Playlist Limits</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="max_tracks_per_playlist" class="form-label">Maximum Tracks per Playlist</label>
                        <input type="number" class="form-control" id="max_tracks_per_playlist" name="max_tracks_per_playlist" value="{{ settings.max_tracks_per_playlist }}" min="1" max="1000" required>
                    </div>
                    <div class="mb-3">
                        <label for="min_tracks_per_playlist" class="form-label">Minimum Tracks per Playlist</label>
                        <input type="number" class="form-control" id="min_tracks_per_playlist" name="min_tracks_per_playlist" value="{{ settings.min_tracks_per_playlist }}" min="1" max="100" required>
                        <div class="form-text">Playlists with fewer tracks will not be created</div>
                    </div>
                    <div class="mb-3">
                        <label for="min_artist_diversity" class="form-label">Minimum Artist Diversity</label>
                        <input type="number" class="form-control" id="min_artist_diversity" name="min_artist_diversity" value="{{ settings.min_artist_diversity or 5 }}" min="1" max="50" required>
                        <div class="form-text">Genre and decade playlists need at least this many different artists</div>
                    </div>
                     <div class="mb-3">
                        <label for="min_albums_per_artist" class="form-label">Minimum Albums per Artist</label>
                        <input type="number" class="form-control" id="min_albums_per_artist" name="min_albums_per_artist" value="{{ settings.min_albums_per_artist or 2 }}" min="1" max="50" required>
                        <div class="form-text">Minimum number of albums required to create an artist playlist</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Playlist Types</h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="type_genre" name="playlist_types" value="Genre" {% if 'Genre' in settings.playlist_types %}checked{% endif %}>
                        <label class="form-check-label" for="type_genre"><i class="fas fa-music me-1"></i>Genre-based playlists</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="type_year" name="playlist_types" value="Year" {% if 'Year' in settings.playlist_types %}checked{% endif %}>
                        <label class="form-check-label" for="type_year"><i class="fas fa-calendar-alt me-1"></i>Decade-based playlists</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="type_artist" name="playlist_types" value="Artist" {% if 'Artist' in settings.playlist_types %}checked{% endif %}>
                        <label class="form-check-label" for="type_artist"><i class="fas fa-user me-1"></i>Artist-based playlists</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="type_personal" name="playlist_types" value="Personal" {% if 'Personal' in settings.playlist_types %}checked{% endif %}>
                        <label class="form-check-label" for="type_personal"><i class="fas fa-user-friends me-1"></i>Personalized playlists</label>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Scheduling</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="auto_generate_on_startup" class="form-label">Startup Behavior</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="auto_generate_on_startup" name="auto_generate_on_startup" {% if settings.auto_generate_on_startup %}checked{% endif %}>
                            <label class="form-check-label" for="auto_generate_on_startup"><i class="fas fa-rocket me-1"></i>Generate playlists automatically on startup</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="schedule_mode" class="form-label">Schedule Mode</label>
                        <select class="form-select" id="schedule_mode" name="schedule_mode" required>
                            <option value="manual" {% if settings.schedule_mode == 'manual' %}selected{% endif %}>Manual Only</option>
                            <option value="daily" {% if settings.schedule_mode == 'daily' %}selected{% endif %}>Daily</option>
                            <option value="interval" {% if settings.schedule_mode == 'interval' %}selected{% endif %}>Interval</option>
                        </select>
                    </div>
                    <div class="mb-3" id="schedule_time_section" style="display: none;">
                        <label for="schedule_time" class="form-label">Daily Generation Time</label>
                        <input type="time" class="form-control" id="schedule_time" name="schedule_time" value="{{ settings.schedule_time or '00:00' }}">
                    </div>
                    <div class="mb-3" id="generation_interval_section" style="display: none;">
                        <label for="generation_interval" class="form-label">Generation Interval (hours)</label>
                        <input type="number" class="form-control" id="generation_interval" name="generation_interval" value="{{ settings.generation_interval }}" min="1" max="168" required>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Personalized Playlist Settings -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-user-cog me-2"></i>Personalized Playlist Settings</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="userSelection" class="form-label">Users for Personalized Playlists</label>
                                <select class="form-select" id="userSelection" name="personal_playlist_users_mode">
                                    <option value="all">All Users</option>
                                    <option value="selected">Selected Users Only</option>
                                </select>
                                <div class="form-text">Choose whether to generate for all users or only selected ones.</div>
                            </div>
                            <div id="selectedUsersContainer" class="mb-3" style="display: none;">
                                <label class="form-label">Select Users</label>
                                <div id="userCheckboxes" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                    <!-- User checkboxes will be loaded here -->
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="newUsersDefault" class="form-label">Default for New Users</label>
                                <select class="form-select" id="newUsersDefault" name="personal_playlist_new_users_default">
                                    <option value="true">Generate playlists for new users by default</option>
                                    <option value="false">Don't generate for new users by default</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="minUserTracks" class="form-label">Minimum Tracks per User</label>
                                <input type="number" class="form-control" id="minUserTracks" name="personal_playlist_min_user_tracks" min="1" max="1000" value="{{ settings.personal_playlist_min_user_tracks or 10 }}">
                            </div>
                            <button type="button" class="btn btn-success" id="generatePersonalizedBtn" style="width: fit-content;">
                                <i class="fas fa-user-music me-1"></i>Generate Personalized Playlists
                            </button>
                        </div>
                        <div class="col-md-4">
                            <h6><i class="fas fa-info-circle me-2"></i>How It Works</h6>
                            <p class="small text-muted">Personalized playlists are created based on user listening habits.</p>
                            <h6>Playlist Types</h6>
                            <ul class="list-unstyled small">
                                <li><i class="fas fa-star text-warning me-2"></i>Top Tracks</li>
                                <li><i class="fas fa-compass text-info me-2"></i>Discovery Mix</li>
                                <li><i class="fas fa-clock text-success me-2"></i>Recent Favorites</li>
                                <li><i class="fas fa-music text-primary me-2"></i>Genre Mix</li>
                            </ul>
                        </div>
                    </div>
                    <div id="userAlertContainer" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Exclusions -->
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-ban me-2"></i>Excluded Genres</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-2">Genres to exclude from playlist generation.</p>
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" id="excluded_genres_input" placeholder="Type genre and press Enter">
                        <button class="btn btn-outline-secondary" type="button" id="loadGenresBtn">
                            <i class="fas fa-download me-1"></i>Load from Jellyfin
                        </button>
                    </div>
                    <div id="available_genres_container" class="mb-2" style="display: none;">
                        <small class="text-muted">Click to add to exclusions:</small>
                        <div id="available_genres_list" class="mt-1"></div>
                    </div>
                    <div id="excluded_genres_container" class="mt-2"></div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-user-slash me-2"></i>Excluded Artists</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-2">Artists to exclude from playlist generation.</p>
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" id="excluded_artists_input" placeholder="Type artist and press Enter">
                        <button class="btn btn-outline-secondary" type="button" id="loadArtistsBtn">
                            <i class="fas fa-download me-1"></i>Load from Jellyfin
                        </button>
                    </div>
                    <div id="available_artists_container" class="mb-2" style="display: none;">
                        <small class="text-muted">Click to add to exclusions:</small>
                        <div id="available_artists_list" class="mt-1"></div>
                    </div>
                    <div id="excluded_artists_container" class="mt-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Spotify and Advanced Settings -->
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fab fa-spotify me-2 text-success"></i>Spotify Integration</h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="spotify_cover_art_enabled" name="spotify_cover_art_enabled" {% if settings.spotify_cover_art_enabled %}checked{% endif %}>
                        <label class="form-check-label" for="spotify_cover_art_enabled">Enable Spotify cover art downloads</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <input type="text" class="form-control mb-2" id="spotify_client_id" name="spotify_client_id" value="{{ settings.spotify_client_id or '' }}" placeholder="Spotify Client ID">
                        </div>
                        <div class="col-md-6">
                            <input type="password" class="form-control" id="spotify_client_secret" name="spotify_client_secret" value="{{ settings.spotify_client_secret or '' }}" placeholder="Spotify Client Secret">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-wrench me-2"></i>Advanced Settings</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="log_level" class="form-label">Log Level</label>
                        <select class="form-select" id="log_level" name="log_level">
                            <option value="DEBUG" {% if settings.log_level == 'DEBUG' %}selected{% endif %}>DEBUG</option>
                            <option value="INFO" {% if settings.log_level == 'INFO' %}selected{% endif %}>INFO</option>
                            <option value="WARNING" {% if settings.log_level == 'WARNING' %}selected{% endif %}>WARNING</option>
                            <option value="ERROR" {% if settings.log_level == 'ERROR' %}selected{% endif %}>ERROR</option>
                        </select>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="shuffle_tracks" name="shuffle_tracks" {% if settings.shuffle_tracks %}checked{% endif %}>
                        <label class="form-check-label" for="shuffle_tracks">Shuffle tracks in playlists</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-end mb-4">
        <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-save me-2"></i>Save All Settings</button>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let excludedGenres = JSON.parse('{{ settings.excluded_genres|tojson|safe }}');
let excludedArtists = JSON.parse('{{ settings.excluded_artists|tojson|safe }}');
let currentUsers = [];
let currentSettings = {}; // Use one settings object

function populateAllSettings() {
    // Basic/Jellyfin
    $('#jellyfin_url').val(currentSettings.jellyfin_url || '');

    // Playlist limits
    $('#max_tracks_per_playlist').val(currentSettings.max_tracks_per_playlist || 100);
    $('#min_tracks_per_playlist').val(currentSettings.min_tracks_per_playlist || 5);
    $('#min_artist_diversity').val(currentSettings.min_artist_diversity || 5);
    $('#min_albums_per_artist').val(currentSettings.min_albums_per_artist || 2);

    // Playlist types
    const types = Array.isArray(currentSettings.playlist_types)
        ? currentSettings.playlist_types
        : (typeof currentSettings.playlist_types === 'string' ? currentSettings.playlist_types.split(',') : []);
    $('#type_genre').prop('checked', types.includes('Genre'));
    $('#type_year').prop('checked', types.includes('Year'));
    $('#type_artist').prop('checked', types.includes('Artist'));
    $('#type_personal').prop('checked', types.includes('Personal'));

    // Scheduling
    const schedMode = currentSettings.schedule_mode || 'manual';
    $('#schedule_mode').val(schedMode);
    handleScheduleModeChange();
    $('#schedule_time').val(currentSettings.schedule_time || '00:00');
    $('#generation_interval').val(currentSettings.generation_interval || 24);
    $('#auto_generate_on_startup').prop('checked', !!currentSettings.auto_generate_on_startup);

    // Advanced
    $('#log_level').val(currentSettings.log_level || 'INFO');
    $('#shuffle_tracks').prop('checked', !!currentSettings.shuffle_tracks);

    // Spotify
    $('#spotify_cover_art_enabled').prop('checked', !!currentSettings.spotify_cover_art_enabled);
    $('#spotify_client_id').val(currentSettings.spotify_client_id || '');
    $('#spotify_client_secret').val(currentSettings.spotify_client_secret || '');
}

// Render functions
function renderExcludedItems(items, containerId, removeFunction) {
    const container = $(`#${containerId}`);
    container.empty();
    if (items.length === 0) {
        container.html('<span class="text-muted">None</span>');
        return;
    }
    items.forEach(item => {
        const badge = $(`<span class="badge bg-danger me-2 mb-2">${escapeHtml(item)} <button type="button" class="btn-close btn-close-white ms-1" onclick="${removeFunction}('${escapeHtml(item)}')"></button></span>`);
        container.append(badge);
    });
}

function renderAvailableItems(items, containerId, type) {
    const container = $(`#${containerId}`);
    container.empty();
    
    if (items.length === 0) {
        container.html('<span class="text-muted">No items found</span>');
        return;
    }
    
    // Sort items alphabetically
    const sortedItems = items.sort();
    
    sortedItems.forEach(item => {
        const isExcluded = type === 'genre' ? excludedGenres.includes(item) : excludedArtists.includes(item);
        const badgeClass = isExcluded ? 'bg-secondary' : 'bg-primary';
        const clickable = isExcluded ? '' : 'style="cursor: pointer;"';
        const title = isExcluded ? 'Already excluded' : 'Click to add to exclusions';
        
        const badge = $(`<span class="badge ${badgeClass} me-2 mb-2" ${clickable} title="${title}">${escapeHtml(item)}</span>`);
        
        if (!isExcluded) {
            badge.click(() => {
                if (type === 'genre') {
                    if (!excludedGenres.includes(item)) {
                        excludedGenres.push(item);
                        renderExcludedItems(excludedGenres, 'excluded_genres_container', 'removeExcludedGenre');
                        renderAvailableItems(items, containerId, type); // Refresh to show as excluded
                    }
                } else {
                    if (!excludedArtists.includes(item)) {
                        excludedArtists.push(item);
                        renderExcludedItems(excludedArtists, 'excluded_artists_container', 'removeExcludedArtist');
                        renderAvailableItems(items, containerId, type); // Refresh to show as excluded
                    }
                }
            });
        }
        
        container.append(badge);
    });
    
    // Show total count
    if (items.length > 0) {
        container.append(`<div class="text-muted small mt-2">Total: ${items.length} items</div>`);
    }
}

function removeExcludedGenre(genre) {
    excludedGenres = excludedGenres.filter(g => g !== genre);
    renderExcludedItems(excludedGenres, 'excluded_genres_container', 'removeExcludedGenre');
}

function removeExcludedArtist(artist) {
    excludedArtists = excludedArtists.filter(a => a !== artist);
    renderExcludedItems(excludedArtists, 'excluded_artists_container', 'removeExcludedArtist');
}

function renderUserCheckboxes() {
    const container = $('#userCheckboxes');
    container.empty();
    if (currentUsers.length === 0) {
        container.html('<p class="text-muted mb-0">No users found in Jellyfin.</p>');
        return;
    }
    currentUsers.forEach(user => {
        const userName = user.Name || 'Unknown User';
        const userId = user.Id || '';
        const isChecked = currentSettings.personal_playlist_users && currentSettings.personal_playlist_users !== 'all' && currentSettings.personal_playlist_users.split(',').includes(userName);
        const checkbox = $(`
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="personal_playlist_users" value="${userName}" id="user_${userId}" ${isChecked ? 'checked' : ''}>
                <label class="form-check-label" for="user_${userId}">${escapeHtml(userName)}</label>
            </div>
        `);
        container.append(checkbox);
    });
}

// Data loading functions
function loadUsers() {
    console.log('Loading users from /api/users...');
    $.get('/api/users')
        .done(data => {
            console.log('Users API response:', data);
            if (data.success) {
                currentUsers = data.users;
                console.log('Loaded users:', currentUsers);
                renderUserCheckboxes();
            } else {
                console.error('Users API returned error:', data.message);
                $('#userCheckboxes').html('<p class="text-danger mb-0">Error loading users: ' + (data.message || 'Unknown error') + '</p>');
            }
        })
        .fail((xhr, status, error) => {
            console.error('Failed to load users:', status, error);
            console.error('Response:', xhr.responseText);
            $('#userCheckboxes').html('<p class="text-danger mb-0">Failed to connect to server. Please check your connection.</p>');
        });
}

function loadCurrentSettings() {
    $.get('/api/settings', data => {
        if (data.success) {
            currentSettings = data.settings;
            // Populate all form fields
            populateAllSettings();
            populateUserForm();
            // Update exclusions UI from persisted settings
            excludedGenres = Array.isArray(currentSettings.excluded_genres) ? currentSettings.excluded_genres : (currentSettings.excluded_genres || []);
            excludedArtists = Array.isArray(currentSettings.excluded_artists) ? currentSettings.excluded_artists : (currentSettings.excluded_artists || []);
            renderExcludedItems(excludedGenres, 'excluded_genres_container', 'removeExcludedGenre');
            renderExcludedItems(excludedArtists, 'excluded_artists_container', 'removeExcludedArtist');
        }
    });
}

// Form population
function populateUserForm() {
    if (!currentSettings.personal_playlist_users) return;
    if (currentSettings.personal_playlist_users === 'all') {
        $('#userSelection').val('all');
        $('#selectedUsersContainer').hide();
    } else {
        $('#userSelection').val('selected');
        $('#selectedUsersContainer').show();
    }
    $('#newUsersDefault').val(String(currentSettings.personal_playlist_new_users_default || false));
    $('#minUserTracks').val(currentSettings.personal_playlist_min_user_tracks || 10);
    renderUserCheckboxes(); // Re-render to apply checks
}

// Event handlers
function handleScheduleModeChange() {
    const mode = $('#schedule_mode').val();
    $('#schedule_time_section').toggle(mode === 'daily');
    $('#generation_interval_section').toggle(mode === 'interval');
}

function setupEventListeners() {
    $('#schedule_mode').change(handleScheduleModeChange);
    
    // Handle user selection dropdown change
    $('#userSelection').change(function() {
        const selectedValue = $(this).val();
        if (selectedValue === 'selected') {
            $('#selectedUsersContainer').show();
            // Load users if not already loaded or refresh them
            if (currentUsers.length === 0) {
                loadUsers();
            } else {
                renderUserCheckboxes();
            }
        } else {
            $('#selectedUsersContainer').hide();
        }
    });

    $('#excluded_genres_input').keypress(e => {
        if (e.which === 13) {
            e.preventDefault();
            const genre = $(e.target).val().trim();
            if (genre && !excludedGenres.includes(genre)) {
                excludedGenres.push(genre);
                renderExcludedItems(excludedGenres, 'excluded_genres_container', 'removeExcludedGenre');
                $(e.target).val('');
            }
        }
    });

    $('#excluded_artists_input').keypress(e => {
        if (e.which === 13) {
            e.preventDefault();
            const artist = $(e.target).val().trim();
            if (artist && !excludedArtists.includes(artist)) {
                excludedArtists.push(artist);
                renderExcludedItems(excludedArtists, 'excluded_artists_container', 'removeExcludedArtist');
                $(e.target).val('');
            }
        }
    });

    $('#userSelection').change(function() {
        $('#selectedUsersContainer').toggle($(this).val() === 'selected');
    });

    $('#settingsForm').submit(function(e) {
        e.preventDefault();
        const button = $(this).find('button[type="submit"]');
        const originalText = button.html();
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');

        const formData = new FormData(this);
        const settings = {};
        let personalUsers = [];

        for (const [key, value] of formData.entries()) {
            if (key === 'playlist_types') {
                if (!settings[key]) settings[key] = [];
                settings[key].push(value);
            } else if (key === 'personal_playlist_users') {
                personalUsers.push(value);
            }
            else {
                settings[key] = value;
            }
        }
        settings.excluded_genres = excludedGenres;
        settings.excluded_artists = excludedArtists;
        
        if (settings.personal_playlist_users_mode === 'all') {
            settings.personal_playlist_users = 'all';
        } else {
            settings.personal_playlist_users = personalUsers.join(',');
        }
        
        // Ensure checkboxes that are not checked are sent as false
        settings.shuffle_tracks = $('#shuffle_tracks').is(':checked');
        settings.spotify_cover_art_enabled = $('#spotify_cover_art_enabled').is(':checked');
        settings.auto_generate_on_startup = $('#auto_generate_on_startup').is(':checked');


        $.ajax({
            url: '/api/settings',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(settings),
            success: data => {
                showAlert(data.message, data.success ? 'success' : 'danger');
            },
            error: () => {
                showAlert('An error occurred while saving settings.', 'danger');
            },
            complete: () => {
                button.prop('disabled', false).html(originalText);
            }
        });
    });

    $('#generatePersonalizedBtn').click(() => {
        const button = $('#generatePersonalizedBtn');
        const originalText = button.html();
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Generating...');
        $.post('/api/generate_personalized', data => {
            showUserAlert(data.message, data.success ? 'success' : 'danger');
        }).fail(() => {
            showUserAlert('Error generating personalized playlists.', 'danger');
        }).always(() => {
            button.prop('disabled', false).html(originalText);
        });
    });
    
    // Load genres button
    $('#loadGenresBtn').click(() => {
        const button = $('#loadGenresBtn');
        const originalText = button.html();
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Loading...');
        
        $.get('/api/metadata')
            .done(data => {
                if (data.success && data.genres) {
                    renderAvailableItems(data.genres, 'available_genres_list', 'genre');
                    $('#available_genres_container').show();
                } else {
                    showAlert('Failed to load genres from Jellyfin.', 'warning');
                }
            })
            .fail(() => {
                showAlert('Error connecting to Jellyfin to load genres.', 'danger');
            })
            .always(() => {
                button.prop('disabled', false).html(originalText);
            });
    });
    
    // Load artists button
    $('#loadArtistsBtn').click(() => {
        const button = $('#loadArtistsBtn');
        const originalText = button.html();
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Loading...');
        
        $.get('/api/artists')
            .done(data => {
                if (data.success && data.artists) {
                    renderAvailableItems(data.artists, 'available_artists_list', 'artist');
                    $('#available_artists_container').show();
                } else {
                    showAlert('Failed to load artists from Jellyfin.', 'warning');
                }
            })
            .fail(() => {
                showAlert('Error connecting to Jellyfin to load artists.', 'danger');
            })
            .always(() => {
                button.prop('disabled', false).html(originalText);
            });
    });
}

function showAlert(message, type = 'success') {
    const alertContainer = $('#alertContainer');
    const alertHtml = `<div class="alert alert-${type} alert-dismissible fade show mt-3" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
    alertContainer.html(alertHtml);
    if (type === 'success') {
        setTimeout(() => alertContainer.find('.alert').fadeOut(500, function() { $(this).remove(); }), 5000);
    }
}

function showUserAlert(message, type) {
    const alertContainer = $('#userAlertContainer');
    const alertHtml = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
    alertContainer.html(alertHtml);
    if (type === 'success') {
        setTimeout(() => alertContainer.find('.alert').fadeOut(500, function() { $(this).remove(); }), 5000);
    }
}

function escapeHtml(text) {
    return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

// Initial load
$(document).ready(function() {
    loadCurrentSettings(); // Load all settings first
    loadUsers(); // Then load users
    renderExcludedItems(excludedGenres, 'excluded_genres_container', 'removeExcludedGenre');
    renderExcludedItems(excludedArtists, 'excluded_artists_container', 'removeExcludedArtist');
    handleScheduleModeChange();
    setupEventListeners();
});
</script>
{% endblock %}
